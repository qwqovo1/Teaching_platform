{% extends "base.html" %}
{% block content %}
<style>
    .video-card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); border-radius: 30px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 40px; border: 2px solid #fff; transition: transform 0.3s ease; text-align: left; }
    .video-card:hover { transform: translateY(-5px); }
</style>
<div class="container" style="max-width: 900px; margin: 0 auto; text-align: center; padding-top: 50px; position: relative; z-index: 10;">
    <h1 class="artistic-title" style="font-size: 3.5rem; margin-bottom: 40px;">âœ¨ æ•™å­¦è§†é¢‘è¯¾å®¤ âœ¨</h1>

    {% if role == 'admin' %}
    <div class="video-card" style="border: 2px dashed #6a82fb; background: rgba(255,255,255,0.6);">
        <h4 style="color: #764ba2; margin-top: 0;">å‘å¸ƒæ–°è¯¾ç¨‹ (ç®¡ç†å‘˜)</h4>
        <form action="/upload-video" method="post" enctype="multipart/form-data">
            <input type="text" name="title" style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #ddd;" placeholder="è§†é¢‘æ ‡é¢˜" required>
            <input type="file" name="video_file" accept="video/*" style="margin-bottom: 15px;">
            <button type="submit" style="background: linear-gradient(135deg, #6a82fb, #fc5c7d); border:none; width: 100%; padding: 12px; color: white; font-weight: bold; border-radius: 15px; cursor: pointer;">ç¡®è®¤ä¸Šä¼ </button>
        </form>
    </div>
    {% endif %}

    {% for video in videos %}
    <div class="video-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: #444; margin: 0; font-weight: bold;">ğŸ¬ {{ video.title }}</h3>
            {% if role == 'admin' %}
            <div style="display: flex; gap: 10px;">
                {% if not loop.first %}
                <form action="/swap-video-order" method="post">
                    <input type="hidden" name="v1_id" value="{{ video.id }}">
                    <input type="hidden" name="v2_id" value="{{ videos[loop.index0 - 1].id }}">
                    <button type="submit" style="background:none; border:none; cursor:pointer; font-size: 20px;">â¬†ï¸</button>
                </form>
                {% endif %}
                {% if not loop.last %}
                <form action="/swap-video-order" method="post">
                    <input type="hidden" name="v1_id" value="{{ video.id }}">
                    <input type="hidden" name="v2_id" value="{{ videos[loop.index0 + 1].id }}">
                    <button type="submit" style="background:none; border:none; cursor:pointer; font-size: 20px;">â¬‡ï¸</button>
                </form>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- ğŸŒŸ ä¿®å¤é»‘å±ï¼šmuted + playsinline + JS å¼ºåˆ¶é¦–å¸§è·³è½¬ -->
        <video id="video-{{ video.id }}" class="lazy-video" controls muted playsinline webkit-playsinline width="100%" style="border-radius: 20px; background: #000;"
               data-src="/video-stream/{{ video.filename }}" onplay="initProgress('{{ video.id }}')" ontimeupdate="updateProgress('{{ video.id }}', this)">
        </video>

        {% if role == 'admin' %}
        <div style="text-align: right; margin-top: 15px;">
            <form action="/delete-video" method="post" onsubmit="return confirm('ç¡®å®šåˆ é™¤ï¼Ÿ');">
                <input type="hidden" name="video_id" value="{{ video.id }}">
                <button type="submit" style="background: #ff7675; color: white; border: none; padding: 8px 20px; border-radius: 10px; cursor: pointer;">åˆ é™¤è§†é¢‘</button>
            </form>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    let v = entry.target; v.src = v.dataset.src; v.load();
                    // ğŸŒŸ è§£å†³é»‘å±ï¼šåŠ è½½å¤´æ•°æ®åå¼ºåˆ¶ç§»åŠ¨æŒ‡é’ˆï¼Œå”¤é†’æ¸²æŸ“
                    v.addEventListener('loadeddata', () => { if(v.readyState >= 2) v.currentTime = 0.1; }, {once:true});
                    observer.unobserve(v);
                }
            });
        }, {threshold: 0.1});
        document.querySelectorAll(".lazy-video").forEach(v => observer.observe(v));
    });

    const lastUpdateTimes = {};
    function updateProgress(videoId, videoElement) {
        const now = Date.now();
        if (!lastUpdateTimes[videoId] || now - lastUpdateTimes[videoId] > 5000) {
            const percent = Math.floor((videoElement.currentTime / videoElement.duration) * 100);
            const fd = new FormData(); fd.append("video_id", videoId); fd.append("progress", percent + "%");
            fetch("/update-progress", {method: "POST", body: fd}).then(r => { if(r.ok) lastUpdateTimes[videoId] = now; });
        }
    }
</script>
{% endblock %}