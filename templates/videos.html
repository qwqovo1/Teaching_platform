{% extends "base.html" %}
{% block content %}
<style>
    .page-container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
    .section-title { color: var(--szu-blue); border-left: 5px solid var(--szu-gold); padding-left: 15px; margin-bottom: 30px; }
    .video-item { background: white; border: 1px solid #e0e0e0; border-radius: 4px; padding: 25px; margin-bottom: 30px; display: grid; grid-template-columns: 1fr 300px; gap: 30px; }
    .video-info h3 { margin: 0 0 15px 0; color: #444; }
    .video-player { background: #000; border-radius: 4px; width: 100%; aspect-ratio: 16/9; }
    .admin-upload { background: #fffbe6; border: 1px solid #ffe58f; padding: 20px; border-radius: 4px; margin-bottom: 30px; }
</style>

<div class="breadcrumb">ä½ç½®ï¼šé¦–é¡µ > è§†é¢‘è¯¾å®¤</div>

<div class="page-container">
    <h2 class="section-title">æ•™å­¦è§†é¢‘èµ„æº</h2>

    {% if role == 'admin' %}
    <div class="admin-upload">
        <h4 style="margin-top:0; color:#856404;"><i class="fa fa-upload"></i> ä¸Šä¼ æ–°è¯¾ä»¶</h4>
        <form action="/upload-video" method="post" enctype="multipart/form-data" style="display:flex; gap:15px; align-items:center;">
            <input type="text" name="title" placeholder="è¾“å…¥è§†é¢‘æ ‡é¢˜" style="flex:1; padding:8px;" required>
            <input type="file" name="video_file" accept="video/*" required>
            <button type="submit" style="background:var(--szu-blue); color:white; border:none; padding:8px 20px; cursor:pointer;">å¼€å§‹ä¸Šä¼ </button>
        </form>
    </div>
    {% endif %}

    {% for video in videos %}
    <div class="video-item">
        <div class="video-player-container">
            <video id="video-{{ video.id }}" class="lazy-video video-player" controls muted playsinline
                   data-src="/video-stream/{{ video.filename }}" onplay="initProgress('{{ video.id }}')" ontimeupdate="updateProgress('{{ video.id }}', this)">
            </video>
        </div>
        <div class="video-info">
            <h3>{{ video.title }}</h3>
            <p style="font-size: 13px; color: #888; line-height: 1.6;">
                <i class="fa fa-info-circle"></i> æœ¬è¯¾ä»¶ä¸ºå®éªŒå®¤å†…éƒ¨æ•™å­¦èµ„æºï¼Œè¯·è§‚çœ‹å¹¶ä¿æŒè¿›åº¦åŒæ­¥ã€‚
            </p>
            {% if role == 'admin' %}
            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                <button onclick="if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) ajaxAction('/delete-video', {video_id: '{{video.id}}'})" style="background:#ff4d4f; color:white; border:none; padding:5px 12px; border-radius:4px; cursor:pointer;">åˆ é™¤</button>
                <div style="margin-top:10px;">
                    <!-- ğŸŒŸ ä¿®å¤ç‚¹ï¼šæ·»åŠ æ¡ä»¶åˆ¤æ–­é˜²æ­¢ç´¢å¼•è¶Šç•Œ -->
                    {% if not loop.first %}
                    <button title="ä¸Šç§»" onclick="ajaxAction('/swap-video-order', {v1_id: '{{video.id}}', v2_id: '{{videos[loop.index0 - 1].id}}'})" style="cursor:pointer; background:none; border:1px solid #ddd; padding:2px 8px;">â†‘</button>
                    {% endif %}

                    {% if not loop.last %}
                    <button title="ä¸‹ç§»" onclick="ajaxAction('/swap-video-order', {v1_id: '{{video.id}}', v2_id: '{{videos[loop.index0 + 1].id}}'})" style="cursor:pointer; background:none; border:1px solid #ddd; padding:2px 8px;">â†“</button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
    async function ajaxAction(url, data) {
        const fd = new FormData();
        for(let k in data) fd.append(k, data[k]);
        await fetch(url, {method: 'POST', body: fd});
        location.reload();
    }
    document.addEventListener("DOMContentLoaded", function() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    let v = entry.target; v.src = v.dataset.src; v.load();
                    observer.unobserve(v);
                }
            });
        });
        document.querySelectorAll(".lazy-video").forEach(v => observer.observe(v));
    });
    const lastUpdateTimes = {};
    function updateProgress(videoId, videoElement) {
        const now = Date.now();
        if (!lastUpdateTimes[videoId] || now - lastUpdateTimes[videoId] > 5000) {
            const percent = Math.floor((videoElement.currentTime / videoElement.duration) * 100);
            const fd = new FormData(); fd.append("video_id", videoId); fd.append("progress", percent + "%");
            fetch("/update-progress", {method: "POST", body: fd}).then(r => { if(r.ok) lastUpdateTimes[videoId] = now; });
        }
    }
</script>
{% endblock %}