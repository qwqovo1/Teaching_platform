{% extends "base.html" %}
{% block content %}
<style>
    .page-container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
    .search-bar { background: white; padding: 20px; border: 1px solid #e0e0e0; margin-bottom: 20px; border-radius: 4px; display: flex; gap: 15px; align-items: center; }
    .search-bar input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    .search-bar button { background: var(--szu-blue); color: white; border: none; padding: 10px 25px; cursor: pointer; border-radius: 4px; }
    .user-table { width: 100%; border-collapse: collapse; background: white; border: 1px solid #e0e0e0; }
    .user-table th { background: #f4f7f9; text-align: left; padding: 15px; border-bottom: 2px solid #e0e0e0; font-size: 14px; }
    .user-table td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; }
    .role-tag { padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .role-admin { background: #fff2e8; color: #fa541c; border: 1px solid #ffbb96; }
    .role-student { background: #f6ffed; color: #52c41a; border: 1px solid #b7eb8f; }
    .batch-actions { margin-bottom: 15px; }
    .batch-btn { background: #ff4d4f; color: white; border: none; padding: 8px 20px; cursor: pointer; border-radius: 4px; font-size: 13px; }
</style>

<div class="breadcrumb">位置：首页 > 账号管理中心</div>

<div class="page-container">
    <h2 style="color:var(--szu-blue); margin-bottom:25px;"><i class="fa fa-users-cog"></i> 实验室用户管理后台</h2>

    <!-- 搜索功能 -->
    <form method="GET" action="/admin/users" class="search-bar">
        <input type="text" name="q" value="{{ search_q }}" placeholder="搜索用户名、学号或昵称...">
        <button type="submit"><i class="fa fa-search"></i> 查找账号</button>
        {% if search_q %}<a href="/admin/users" style="color:#999; text-decoration:none; font-size:13px;">清除搜索</a>{% endif %}
    </form>

    <form id="userBatchForm" action="/admin/batch-delete-users" method="POST">
        <div class="batch-actions">
            <button type="button" class="batch-btn" onclick="confirmBatchDelete()">注销选中账号</button>
        </div>

        <table class="user-table">
            <thead>
                <tr>
                    <th style="width: 40px;"><input type="checkbox" id="selectAll"></th>
                    <th>头像</th>
                    <th>学号 / 账号</th>
                    <th>昵称</th>
                    <th>权限角色</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>
                        {% if u.role != 'admin' %}
                        <input type="checkbox" name="usernames" value="{{ u.username }}">
                        {% endif %}
                    </td>
                    <td><img src="{{ u.avatar }}" style="width:40px; height:40px; border-radius:50%; border:1px solid #eee;"></td>
                    <td style="font-weight:bold; color:var(--szu-blue);">{{ u.username }}</td>
                    <td>{{ u.nickname }}</td>
                    <td>
                        <span class="role-tag {% if u.role == 'admin' %}role-admin{% else %}role-student{% endif %}">
                            {{ u.role }}
                        </span>
                    </td>
                    <td>
                        {% if u.role != 'admin' %}
                        <button type="button" onclick="deleteUser('{{ u.username }}')" style="background:none; border:1px solid #ff4d4f; color:#ff4d4f; padding:4px 12px; border-radius:4px; cursor:pointer;">注销</button>
                        {% else %}
                        <span style="color:#ccc; font-size:12px;"><i class="fa fa-lock"></i> 系统保护</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" style="text-align:center; padding:50px; color:#999;">未找到匹配的账号</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
</div>

<script>
    document.getElementById('selectAll').onclick = function() {
        let checkboxes = document.getElementsByName('usernames');
        for (let checkbox of checkboxes) checkbox.checked = this.checked;
    }

    async function deleteUser(u) {
        if(!confirm('确定要注销此账号吗？该操作不可撤销。')) return;
        const fd = new FormData(); fd.append('target_user', u);
        const resp = await fetch('/admin/delete-user', {method: 'POST', body: fd});
        if((await resp.json()).status === 'ok') location.reload();
    }

    function confirmBatchDelete() {
        let checked = document.querySelectorAll('input[name="usernames"]:checked');
        if(checked.length === 0) { alert('请先勾选需要注销的账号'); return; }
        if(confirm('确定要批量注销这 ' + checked.length + ' 个账号吗？')) {
            document.getElementById('userBatchForm').submit();
        }
    }
</script>
{% endblock %}