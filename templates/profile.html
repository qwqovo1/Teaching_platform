{% extends "base.html" %}

{% block content %}
<div class="card-container" style="max-width: 600px; position: relative; z-index: 10;">
    <h2 class="artistic-title" style="font-size: 2.5rem;">ä¸ªäººä¸­å¿ƒ</h2>

    <!-- ç”¨æˆ·èµ„æ–™ -->
    <form action="/update-profile" method="post" enctype="multipart/form-data">
        <label style="cursor: pointer; display: inline-block;">
            <img src="{{ avatar }}" id="avatar-preview"
                 style="width: 110px; height: 110px; border-radius: 50%; border: 4px solid #764ba2; object-fit: cover; background: #fff;">
            <input type="file" name="avatar_file" style="display:none;" onchange="preview(this)">
            <p style="font-size: 12px; color: #764ba2; font-weight: bold; margin-top: 10px;">ç‚¹å‡»æ›´æ¢å¤´åƒ</p>
        </label>
        <div style="text-align: left; margin-top: 15px;">
            <label style="font-weight:bold;">æ˜µç§°ï¼š</label>
            <input type="text" name="nickname" class="form-input" value="{{ nickname }}" required>
        </div>
        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">æ›´æ–°ä¸ªäººèµ„æ–™</button>
    </form>

    <div style="margin-top: 15px; text-align: right;">
        <a href="/change-password" style="color: #666; font-size: 13px; text-decoration: none;">ğŸ” ä¿®æ”¹ç™»å½•å¯†ç </a>
    </div>

    <!-- æˆç»©å­˜æ¡£å±•ç¤º (ä¸æä¾›ä¸‹è½½) -->
    <div style="margin-top: 30px; text-align: left; background: rgba(255,255,255,0.85); padding: 20px; border-radius: 20px;">
        <h4 style="color: #764ba2; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0;">ğŸ“Š å®éªŒæˆç»©å­˜æ¡£</h4>
        <div style="max-height: 150px; overflow-y: auto;">
            {% for r in records %}
            <p style="margin: 10px 0; color: #2ed573; font-size: 14px; font-weight: bold;">âœ“ å·²å®Œæˆå­˜æ¡£ï¼š{{ r }}</p>
            {% else %}
            <p style="color: #999; font-size: 13px;">æš‚æ— ç­”é¢˜è®°å½•</p>
            {% endfor %}
        </div>
    </div>

    <!-- ğŸŒŸ åŸæœ‰åŠŸèƒ½ï¼šè§†é¢‘è¿›åº¦è¯¦æƒ… (å·²å›å½’) -->
    <div style="margin-top: 20px;">
        <button onclick="toggleProgress()" class="btn-primary" style="width: 100%; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border:none;">ğŸ“… æŸ¥çœ‹è¯¾ä»¶è§‚çœ‹è¿›åº¦</button>
        <div id="prog-box" style="display:none; margin-top:15px; background:rgba(255,255,255,0.9); padding:15px; border-radius:15px; text-align:left;">
            <h5 style="margin: 0 0 10px 0;">å·²åŒæ­¥è¿›åº¦åˆ—è¡¨ï¼š</h5>
            <div id="prog-content" style="font-size: 14px;">æ­£åœ¨åŒæ­¥ä¸­...</div>
        </div>
    </div>

    {% if role == 'admin' %}
    <div style="margin-top: 30px; border-top: 2px dashed #ff4757; padding-top: 20px;">
        <p style="color: #ff4757; font-weight: bold; font-size: 13px; text-align: left;">ğŸ›¡ï¸ ç®¡ç†å‘˜é¢æ¿ï¼š</p>
        <form action="/reset-all" method="post" onsubmit="return confirm('ç¡®å®šè¦åˆ·æ–°æ‰€æœ‰æˆå‘˜ç­”é¢˜æœºä¼šå—ï¼Ÿï¼ˆè®°å½•æ–‡ä»¶ä¼šä¿ç•™ï¼‰');">
            <button type="submit" class="btn-primary" style="background: #ff4757; width: 100%;">åˆ·æ–°äº¤å·æœºä¼š</button>
        </form>
    </div>
    {% endif %}

    <form action="/logout" method="post" style="margin-top: 30px;">
        <button type="submit" style="background:none; border:none; color:#bbb; cursor:pointer; font-size: 13px; text-decoration: underline;">[ é€€å‡ºç™»å½• ]</button>
    </form>
</div>

<script>
function preview(i) {
    if(i.files && i.files[0]) {
        var r = new FileReader();
        r.onload = e => document.getElementById('avatar-preview').src = e.target.result;
        r.readAsDataURL(i.files[0]);
    }
}

// è§†é¢‘è¿›åº¦æŠ“å–é€»è¾‘
async function toggleProgress() {
    const box = document.getElementById('prog-box');
    const content = document.getElementById('prog-content');
    box.style.display = box.style.display === 'none' ? 'block' : 'none';
    if(box.style.display === 'block') {
        try {
            const res = await fetch('/get-video-progress');
            const data = await res.json();
            if(!data || data.length === 0) content.innerHTML = "æš‚æ— è§‚çœ‹è®°å½•";
            else content.innerHTML = data.map(i => `<div style="padding:8px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span>ğŸ¬ ${i.title}</span> <b style="color:#764ba2;">${i.progress}</b></div>`).join('');
        } catch(e) { content.innerHTML = "åŒæ­¥å¤±è´¥"; }
    }
}
</script>
{% endblock %}