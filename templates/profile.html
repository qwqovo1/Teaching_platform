{% extends "base.html" %}

{% block content %}
<div class="card-container" style="max-width: 600px; position: relative; z-index: 10;">
    <h2 class="artistic-title" style="font-size: 2.5rem;">ä¸ªäººä¸­å¿ƒ</h2>

    <!-- ç”¨æˆ·èµ„æ–™ -->
    <form action="/update-profile" method="post" enctype="multipart/form-data">
        <label style="cursor: pointer; display: inline-block;">
            <img src="{{ avatar }}" id="avatar-preview"
                 style="width: 110px; height: 110px; border-radius: 50%; border: 4px solid #764ba2; object-fit: cover; background: #fff;">
            <input type="file" name="avatar_file" style="display:none;" onchange="preview(this)">
            <p style="font-size: 12px; color: #764ba2; font-weight: bold; margin-top: 10px;">ç‚¹å‡»æ›´æ¢å¤´åƒ</p>
        </label>
        <div style="text-align: left; margin-top: 15px;">
            <label style="font-weight:bold;">æ˜µç§°ï¼š</label>
            <input type="text" name="nickname" class="form-input" value="{{ nickname }}" required>
        </div>
        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">æ›´æ–°ä¸ªäººèµ„æ–™</button>
    </form>

    <div style="margin-top: 15px; text-align: right;">
        <a href="/change-password" style="color: #666; font-size: 13px; text-decoration: none;">ğŸ” ä¿®æ”¹ç™»å½•å¯†ç </a>
    </div>

    <!-- æˆç»©å­˜æ¡£å±•ç¤º -->
    <div style="margin-top: 30px; text-align: left; background: rgba(255,255,255,0.85); padding: 20px; border-radius: 20px;">
        <h4 style="color: #764ba2; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0;">ğŸ“Š å®éªŒæˆç»©å­˜æ¡£</h4>
        <div style="max-height: 200px; overflow-y: auto;">
            {% for r in records %}
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                <span style="color: #2ed573; font-size: 13px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%;">âœ“ {{ r }}</span>
                <div style="flex-shrink: 0;">
                    <a href="/view-record/{{ r }}" target="_blank" style="font-size: 12px; color: #3498db; text-decoration: none; margin-right: 8px;">[æŸ¥çœ‹]</a>
                    {% if role == 'admin' %}
                    <a href="/download-record/{{ r }}" style="font-size: 12px; color: #2ecc71; text-decoration: none;">[ä¸‹è½½]</a>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <p style="color: #999; font-size: 13px; text-align: center;">æš‚æ— ç­”é¢˜è®°å½•</p>
            {% endfor %}
        </div>
    </div>

    <!-- è§†é¢‘è¿›åº¦è¯¦æƒ… -->
    <div style="margin-top: 20px;">
        <button onclick="toggleProgress()" class="btn-primary" style="width: 100%; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border:none;">ğŸ“… æŸ¥çœ‹è¯¾ä»¶è§‚çœ‹è¿›åº¦</button>
        <div id="prog-box" style="display:none; margin-top:15px; background:rgba(255,255,255,0.9); padding:15px; border-radius:15px; text-align:left;">
            <h5 style="margin: 0 0 10px 0;">å·²åŒæ­¥è¿›åº¦åˆ—è¡¨ï¼š</h5>
            <div id="prog-content" style="font-size: 14px;">æ­£åœ¨åŒæ­¥ä¸­...</div>
        </div>
    </div>

    {% if role == 'admin' %}
    <div style="margin-top: 30px; border-top: 2px dashed #ff4757; padding-top: 20px;">
        <p style="color: #ff4757; font-weight: bold; font-size: 13px; text-align: left;">ğŸ›¡ï¸ ç®¡ç†å‘˜é¢æ¿ï¼š</p>
        <form action="/reset-all" method="post" onsubmit="return confirm('ç¡®å®šè¦åˆ·æ–°æ‰€æœ‰æˆå‘˜ç­”é¢˜æœºä¼šå—ï¼Ÿï¼ˆè®°å½•æ–‡ä»¶ä¼šä¿ç•™ï¼‰');">
            <button type="submit" class="btn-primary" style="background: #ff4757; width: 100%;">åˆ·æ–°äº¤å·æœºä¼š</button>
        </form>
    </div>
    {% endif %}

    <form action="/logout" method="post" style="margin-top: 30px;">
        <button type="submit" style="background:none; border:none; color:#bbb; cursor:pointer; font-size: 13px; text-decoration: underline;">[ é€€å‡ºç™»å½• ]</button>
    </form>
</div>

<script>
function preview(i) {
    if(i.files && i.files[0]) {
        var r = new FileReader();
        r.onload = e => document.getElementById('avatar-preview').src = e.target.result;
        r.readAsDataURL(i.files[0]);
    }
}

async function toggleProgress() {
    const box = document.getElementById('prog-box');
    const content = document.getElementById('prog-content');
    box.style.display = box.style.display === 'none' ? 'block' : 'none';
    if(box.style.display === 'block') {
        try {
            // ğŸŒŸ æ ¸å¿ƒä¿®å¤é€»è¾‘ï¼šåç«¯ç°åœ¨è¿”å›æ­£ç¡®çš„ JSON æ ¼å¼ï¼Œè¿™é‡Œå°†èƒ½æˆåŠŸè§£æ
            const res = await fetch('/get-video-progress');
            if (!res.ok) throw new Error("ç½‘ç»œå“åº”ä¸æ­£å¸¸");
            const data = await res.json();

            if(!data || data.length === 0) {
                content.innerHTML = '<p style="color:#999; text-align:center;">æš‚æ— è§‚çœ‹è®°å½•</p>';
            } else {
                content.innerHTML = data.map(i => `
                    <div style="padding:10px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <span style="color:#333;">ğŸ¬ ${i.title}</span>
                        <b style="color:#764ba2; background:#f0e6ff; padding:2px 8px; border-radius:10px; font-size:12px;">${i.progress}</b>
                    </div>
                `).join('');
            }
        } catch(e) {
            console.error("åŒæ­¥è¿›åº¦å¤±è´¥:", e);
            content.innerHTML = '<p style="color:#ff4757; text-align:center;">åŒæ­¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</p>';
        }
    }
}
</script>
{% endblock %}