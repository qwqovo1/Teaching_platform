{% extends "base.html" %}

{% block content %}
<style>
    .breadcrumb { background: #fff; padding: 10px 5%; border-bottom: 1px solid #eee; font-size: 13px; color: #666; }
    .profile-container { max-width: 1200px; margin: 30px auto; display: grid; grid-template-columns: 300px 1fr; gap: 30px; padding: 0 20px; }
    .profile-box { background: white; border: 1px solid #e0e0e0; border-radius: 4px; padding: 25px; }
    .profile-box h3 { margin-top: 0; font-size: 18px; color: var(--szu-blue); border-left: 4px solid var(--szu-gold); padding-left: 12px; margin-bottom: 25px; }
    .record-search { margin-bottom: 20px; display: flex; gap: 10px; }
    .record-search input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
    .record-search button { background: var(--szu-blue); color: white; border: none; padding: 0 20px; border-radius: 4px; cursor: pointer; }
    .record-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .record-table th { background: #f8f9fa; text-align: left; padding: 12px; font-size: 14px; border-bottom: 2px solid #eee; }
    .record-table td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
    .btn-action { text-decoration: none; font-weight: bold; margin-right: 15px; color: var(--szu-blue); font-size: 13px; }
    .admin-tools { background: #fffbe6; border: 1px solid #ffe58f; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
</style>

<div class="breadcrumb">ä½ç½®ï¼š<a href="/index">é¦–é¡µ</a> > ä¸ªäººä¸­å¿ƒ</div>

<div class="profile-container">
    <!-- å·¦ä¾§ï¼šèµ„æ–™è®¾ç½® -->
    <aside class="profile-box" style="height: fit-content;">
        <h3>è´¦æˆ·è®¾ç½®</h3>
        <form action="/update-profile" method="post" enctype="multipart/form-data" style="text-align: center;">
            <label style="cursor: pointer; display: inline-block; position: relative;">
                <img src="{{ avatar }}" id="avatar-preview" style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid #eee; object-fit: cover;">
                <input type="file" name="avatar_file" style="display:none;" onchange="preview(this)">
            </label>
            <p style="font-size: 12px; color: #999; margin: 10px 0 20px;">ç‚¹å‡»æ›´æ¢ç…§ç‰‡</p>
            <div style="text-align: left; margin-bottom: 20px;">
                <label style="font-size: 13px; font-weight: bold; color: #666;">ç”¨æˆ·æ˜µç§°</label>
                <input type="text" name="nickname" value="{{ nickname }}" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
            </div>
            <button type="submit" style="width: 100%; background: var(--szu-blue); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">ä¿å­˜æ›´æ–°</button>
        </form>
        <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
        <div style="text-align: center;">
            <a href="/change-password" style="color: #666; font-size: 13px; text-decoration: none;"><i class="fa fa-lock"></i> ä¿®æ”¹å¯†ç </a>
        </div>
        <form action="/logout" method="post" style="margin-top: 20px; text-align: center;">
            <button type="submit" style="background: none; border: none; color: #ff4d4f; cursor: pointer; font-size: 13px;">[ é€€å‡ºç™»å½• ]</button>
        </form>
    </aside>

    <!-- å³ä¾§ï¼šè®°å½•ç®¡ç† -->
    <main>
        <div class="profile-box">
            <h3>å®éªŒæˆç»©å­˜æ¡£</h3>

            <!-- æˆç»©å•æœç´¢è¡¨å• -->
            <form method="GET" action="/profile" class="record-search">
                <input type="text" name="record_q" value="{{ record_q }}" placeholder="æŒ‰å­˜æ¡£æ–‡ä»¶åå…³é”®å­—æœç´¢æŠ¥å‘Šå•...">
                <button type="submit">æœç´¢</button>
                {% if record_q %}<a href="/profile" style="font-size:12px; align-self:center; color:#999; margin-left:10px;">æ¸…ç©º</a>{% endif %}
            </form>

            {% if role == 'admin' %}
            <div class="admin-tools">
                <span style="font-size:13px; color:#856404; font-weight:bold;">ç®¡ç†å‘˜æ‰¹é‡å·¥å…·ï¼š</span>
                <button type="button" onclick="batchRec('download')" style="background:#fa8c16; color:white; border:none; padding:5px 15px; border-radius:3px; cursor:pointer; font-size:12px;">æ‰¹é‡ä¸‹è½½é€‰ä¸­</button>
                <button type="button" onclick="batchRec('delete')" style="background:#ff4d4f; color:white; border:none; padding:5px 15px; border-radius:3px; cursor:pointer; font-size:12px; margin-left:10px;">æ‰¹é‡åˆ é™¤é€‰ä¸­</button>
            </div>
            {% endif %}

            <form id="recForm" method="POST">
                <table class="record-table">
                    <thead>
                        <tr>
                            {% if role == 'admin' %}<th style="width:30px;"><input type="checkbox" id="selAllRec"></th>{% endif %}
                            <th>å­˜æ¡£æŠ¥å‘Šå•åç§°</th>
                            <th>å­˜æ¡£çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in records %}
                        <tr>
                            {% if role == 'admin' %}<td><input type="checkbox" name="filenames" value="{{ r }}"></td>{% endif %}
                            <td style="color:#444;">{{ r }}</td>
                            <td><span style="color:#52c41a;"><i class="fa fa-check-circle"></i> å·²å­˜æ¡£</span></td>
                            <td>
                                <a href="/view-record/{{ r }}" target="_blank" class="btn-action">é¢„è§ˆæŠ¥å‘Š</a>
                                <a href="/download-record/{{ r }}" class="btn-action" style="color:#52c41a;">ä¸‹è½½æŠ¥å‘Šå•</a>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="4" style="text-align:center; padding:50px; color:#999;">æš‚æ— åŒ¹é…çš„æˆç»©è®°å½•</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </form>
        </div>

        <div class="profile-box" style="margin-top:25px;">
            <h3>è¯¾ä»¶è§‚çœ‹è¿›åº¦è‡ªæµ‹</h3>
            <button onclick="toggleProg()" style="background:#f0f2f5; border:1px solid #ccc; padding:8px 15px; cursor:pointer; border-radius:4px; font-size:13px;">æŸ¥çœ‹å½“å‰å·²åŒæ­¥è¿›åº¦</button>
            <div id="prog-list" style="display:none; margin-top:15px; border:1px solid #eee; background:#fafafa; padding:15px;"></div>
        </div>

        {% if role == 'admin' %}
        <div class="profile-box" style="margin-top:25px; border-top:3px solid #ff4d4f;">
            <h3 style="color:#ff4d4f;">ç³»ç»Ÿç‰¹æƒç®¡ç†</h3>
            <div style="display:flex; gap:15px;">
                <form action="/reset-all" method="post" onsubmit="return confirm('è­¦å‘Šï¼šç¡®å®šé‡ç½®æ‰€æœ‰æˆå‘˜ç­”é¢˜æœºä¼šï¼Ÿ');">
                    <button type="submit" style="background:#ff4d4f; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">é‡ç½®å…¨ç«™ç­”é¢˜é”</button>
                </form>
                <a href="/admin/users" style="background:var(--szu-blue); color:white; text-decoration:none; padding:10px 20px; border-radius:4px; font-size:14px;">ç®¡ç†æ‰€æœ‰è´¦å·</a>
            </div>
        </div>
        {% endif %}
    </main>
</div>

<script>
    function preview(i){
        if(i.files && i.files[0]){
            var r=new FileReader();
            r.onload=e=>document.getElementById('avatar-preview').src=e.target.result;
            r.readAsDataURL(i.files[0]);
        }
    }

    document.getElementById('selAllRec') && (document.getElementById('selAllRec').onclick=function(){
        let cbs=document.getElementsByName('filenames'); for(let cb of cbs) cb.checked=this.checked;
    });

    function batchRec(act) {
        let f=document.getElementById('recForm'), checked=document.querySelectorAll('input[name="filenames"]:checked');
        if(checked.length===0){ alert('è¯·å…ˆé€‰æ‹©æŠ¥å‘Šå•'); return; }
        if(act==='delete' && !confirm('ç¡®å®šç‰©ç†åˆ é™¤é€‰ä¸­çš„ ' + checked.length + ' ä¸ªæŠ¥å‘Šå•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
        f.action = act==='delete' ? '/admin/batch-delete-records' : '/admin/batch-download-records';
        f.submit();
    }

    async function toggleProg() {
        let b=document.getElementById('prog-list');
        if(b.style.display==='block'){ b.style.display='none'; return; }
        b.style.display='block'; b.innerHTML='æ­£åœ¨ä»æœåŠ¡å™¨åŒæ­¥è¿›åº¦...';
        let r=await fetch('/get-video-progress'), d=await r.json();
        b.innerHTML = d.length ? d.map(i=>`<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #ddd;"><span>ğŸ¬ ${i.title}</span><b style="color:var(--szu-blue);">${i.progress}</b></div>`).join('') : 'æš‚æ— è¿›åº¦è®°å½•';
    }
</script>
{% endblock %}