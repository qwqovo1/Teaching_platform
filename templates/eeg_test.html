{% extends "base.html" %}
{% block content %}
<style>
    .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .opt-btn {
        padding: 18px; border: 2px solid #eef2f7; border-radius: 12px;
        background: #fff; cursor: pointer; transition: 0.2s; text-align: left;
    }
    .opt-btn:hover:not(.locked) { border-color: #764ba2; background: #fdfbff; transform: translateY(-2px); }
    .opt-btn.active { background: #764ba2; color: #fff; border-color: #764ba2; box-shadow: 0 5px 15px rgba(118,75,162,0.3); }
    .opt-btn.locked { cursor: not-allowed; opacity: 0.8; }
</style>

<div class="test-container" style="max-width: 850px; margin: 40px auto; position: relative; z-index: 10;">
    <h1 class="artistic-title" style="font-size: 3rem;">å®éªŒè€ƒæ ¸è‡ªæµ‹</h1>

    {% if already_finished %}
    <div class="card-container" style="padding: 40px; text-align: center; border: 2px solid #2ed573;">
        <h2 style="color: #2ed573;">âœ“ å®éªŒå·²äº¤å·</h2>
        <p>æ‚¨çš„ä½œç­”å·²é”å®šï¼Œæˆç»©å•å·²å­˜æ¡£ã€‚</p>
    </div>
    {% endif %}

    <div style="{% if already_finished %} pointer-events: none; {% endif %}">
        {% if role == 'admin' %}
        <div class="card-container" style="border: 2px dashed #6c5ce7; margin-bottom: 30px; text-align: left;">
            <h4 style="color: #6c5ce7;">ğŸ›¡ï¸ ç®¡ç†å‘˜ï¼šæ·»åŠ æ–°é¢˜</h4>
            <form action="/add-question" method="post">
                <input type="text" name="content" class="form-input" placeholder="é¢˜å¹²" required>
                <div class="opt-grid">
                    <input type="text" name="option_a" class="form-input" placeholder="A" required>
                    <input type="text" name="option_b" class="form-input" placeholder="B" required>
                    <input type="text" name="option_c" class="form-input" placeholder="C" required>
                    <input type="text" name="option_d" class="form-input" placeholder="D" required>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">å‘å¸ƒ</button>
            </form>
        </div>
        {% endif %}

        {% for q in questions %}
        <div class="card-container" style="text-align: left; margin-bottom: 25px; padding: 30px;">
            <p><strong>{{ loop.index }}. {{ q.content }}</strong></p>
            <div class="opt-grid">
                {% for opt in ['A','B','C','D'] %}
                <button onclick="pick('{{q.id}}','{{opt}}')" id="btn_{{q.id}}_{{opt}}"
                        class="opt-btn {{ 'active' if answered[q.id] and answered[q.id].selected_option == opt else '' }} {{ 'locked' if already_finished else '' }}">
                    {{ opt }}. {{ q['option_' + opt.lower()] }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        {% if not already_finished %}
        <form action="/finish-test" method="post" onsubmit="return confirm('ç¡®è®¤æ­£å¼äº¤å·ï¼Ÿ');">
            <button type="submit" class="btn-primary" style="width: 100%; height: 60px; background: #2ed573;">ç¡®è®¤äº¤å·å¯¼å‡º ğŸ“</button>
        </form>
        {% endif %}
    </div>
</div>

<script>
async function pick(qid, opt) {
    document.querySelectorAll(`[id^="btn_${qid}_"]`).forEach(b => b.classList.remove('active'));
    document.getElementById(`btn_${qid}_${opt}`).classList.add('active');
    const fd = new FormData(); fd.append('qid', qid); fd.append('opt', opt);
    await fetch('/submit-answer', {method: 'POST', body: fd});
}
</script>
{% endblock %}