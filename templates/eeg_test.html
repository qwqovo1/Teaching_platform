{% extends "base.html" %}
{% block content %}
<style>
    .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .opt-btn { padding: 18px; border: 2px solid #eef2f7; border-radius: 12px; background: #fff; cursor: pointer; transition: 0.2s; text-align: left; }
    .opt-btn.active { background: #764ba2; color: #fff; border-color: #764ba2; }
    .admin-box { background: #f8f9fa; padding: 15px; border-radius: 15px; margin-top: 20px; border: 1px dashed #764ba2; }
</style>
<div class="test-container" style="max-width: 850px; margin: 40px auto; position: relative; z-index: 10; text-align: center;">
    <h1 class="artistic-title" style="font-size: 3rem;">å®éªŒè€ƒæ ¸è‡ªæµ‹</h1>
    {% if already_finished %}<h2 style="color: #2ed573;">âœ“ å®éªŒå·²äº¤å·ï¼Œæˆç»©å·²å­˜æ¡£</h2>{% endif %}

    <div style="{% if already_finished %} pointer-events: none; opacity: 0.8; {% endif %}">
        {% if role == 'admin' %}
        <div class="card-container" style="border: 2px dashed #6c5ce7; margin-bottom: 30px; text-align: left; padding: 25px;">
            <h4 style="color: #6c5ce7; margin-top: 0;">ğŸ›¡ï¸ ç®¡ç†å‘˜ï¼šæ·»åŠ æ–°é¢˜</h4>
            <form onsubmit="event.preventDefault(); ajaxFormSubmit(this, '/add-question');">
                <input type="text" name="content" style="width:100%; padding:10px; margin-bottom:10px;" placeholder="è¾“å…¥é¢˜å¹²" required>
                <div class="opt-grid">
                    <input type="text" name="option_a" placeholder="é€‰é¡¹ A" required> <input type="text" name="option_b" placeholder="é€‰é¡¹ B" required>
                    <input type="text" name="option_c" placeholder="é€‰é¡¹ C" required> <input type="text" name="option_d" placeholder="é€‰é¡¹ D" required>
                </div>
                æ­£ç¡®é€‰é¡¹(A/B/C/D): <input type="text" name="answer" style="width:50px;" required>
                <button type="submit" class="btn-primary" style="width: 100%; margin-top: 10px;">å‘å¸ƒ</button>
            </form>
        </div>
        {% endif %}

        {% for q in questions %}
        <div class="card-container" style="text-align: left; margin-bottom: 25px; padding: 30px;">
            <p><strong>{{ loop.index }}. {{ q.content }}</strong></p>
            <div class="opt-grid">
                {% for opt in ['A','B','C','D'] %}
                <button onclick="pick('{{q.id}}','{{opt}}')" id="btn_{{q.id}}_{{opt}}" class="opt-btn {{ 'active' if answered[q.id] and answered[q.id].selected_option == opt else '' }}">
                    {{ opt }}. {{ q['option_' + opt.lower()] }}
                </button>
                {% endfor %}
            </div>

            {% if role == 'admin' %}
            <div class="admin-box">
                <form onsubmit="event.preventDefault(); ajaxFormSubmit(this, '/edit-question');">
                    <input type="hidden" name="qid" value="{{ q.id }}">
                    å†…å®¹: <input type="text" name="content" value="{{ q.content }}" style="width:85%"><br><br>
                    é€‰é¡¹: A:<input type="text" name="option_a" value="{{ q.option_a }}" size="8"> B:<input type="text" name="option_b" value="{{ q.option_b }}" size="8">
                    C:<input type="text" name="option_c" value="{{ q.option_c }}" size="8"> D:<input type="text" name="option_d" value="{{ q.option_d }}" size="8"><br><br>
                    æ­£ç¡®ç­”æ¡ˆ: <input type="text" name="answer" value="{{ q.answer }}" size="2">
                    <button type="submit" style="background:#764ba2; color:white; border:none; padding:5px 12px; border-radius:5px; cursor:pointer;">ä¿å­˜ä¿®æ”¹</button>
                </form>
                <button onclick="if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) ajaxAction('/delete-question', {qid: '{{q.id}}'})" style="background:#ff7675; color:white; border:none; padding:5px 12px; border-radius:5px; cursor:pointer; margin-top:10px;">åˆ é™¤æ­¤é¢˜</button>
            </div>
            {% endif %}
        </div>
        {% endfor %}

        {% if not already_finished %}
        <form action="/finish-test" method="post" onsubmit="return confirm('ç¡®è®¤äº¤å·ï¼Ÿ');">
            <button type="submit" class="btn-primary" style="width: 100%; height: 60px; background: #2ed573;">ç¡®è®¤äº¤å·å¯¼å‡º ğŸ“</button>
        </form>
        {% endif %}
    </div>
</div>
<script>
window.addEventListener('load', () => {
    const y = sessionStorage.getItem('q_scroll');
    if(y) { window.scrollTo(0, parseInt(y)); sessionStorage.removeItem('q_scroll'); }
});

async function ajaxFormSubmit(form, url) {
    sessionStorage.setItem('q_scroll', window.scrollY);
    await fetch(url, {method: 'POST', body: new FormData(form)});
    location.reload();
}

async function ajaxAction(url, data) {
    sessionStorage.setItem('q_scroll', window.scrollY);
    const fd = new FormData();
    for(let k in data) fd.append(k, data[k]);
    await fetch(url, {method: 'POST', body: fd});
    location.reload();
}

async function pick(qid, opt) {
    document.querySelectorAll(`[id^="btn_${qid}_"]`).forEach(b => b.classList.remove('active'));
    document.getElementById(`btn_${qid}_${opt}`).classList.add('active');
    const fd = new FormData(); fd.append('qid', qid); fd.append('opt', opt);
    await fetch('/submit-answer', {method: 'POST', body: fd});
}
</script>
{% endblock %}